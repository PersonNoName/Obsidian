# 安全认证

## 概述

项目使用 **Spring Security + JWT** 实现无状态认证机制。

## 认证流程

```
┌──────────┐    ┌──────────────┐    ┌─────────────┐    ┌────────────┐
│  Client  │───▶│ AuthController│───▶│  UserService│───▶│  Database  │
└──────────┘    └──────────────┘    └─────────────┘    └────────────┘
     │                │                   │                 │
     │   POST /login  │                   │                 │
     │◀───────────────│                   │                 │
     │    JWT Token   │                   │                 │
     │                │                   │                 │
     │   GET /sectors │                   │                 │
     │   Header:      │                   │                 │
     │   Bearer <token│                   │                 │
     │◀───────────────│                   │                 │
```

## SecurityConfig - 安全配置

**文件位置**: `config/SecurityConfig.java`

### 配置要点

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            // 禁用 CSRF
            .csrf(AbstractHttpConfigurer::disable)
            // 启用 CORS
            .cors(cors -> {})
            // 配置路由权限
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/auth/**").permitAll()      // 登录/注册无需认证
                .requestMatchers("/api/sectors/**").permitAll()    // 板块数据公开
                .anyRequest().authenticated())                     // 其他请求需认证
            // 无状态会话
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            // 配置认证提供者
            .authenticationProvider(authenticationProvider())
            // JWT 过滤器在用户名密码过滤器之前执行
            .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}
```

### 关键配置说明

| 配置项 | 说明 |
|--------|------|
| `csrf().disable()` | 禁用 CSRF 保护（JWT 无状态不需要） |
| `cors()` | 启用跨域配置 |
| `permitAll()` | 无需认证即可访问 |
| `authenticated()` | 需要认证才能访问 |
| `STATELESS` | 无状态会话，不存储 Session |

## 路由权限配置

```java
// 认证相关接口 - 公开
.requestMatchers("/api/auth/**").permitAll()

// 板块数据 - 公开
.requestMatchers("/api/sectors/**").permitAll()

// 收藏接口 - 需要认证
.anyRequest().authenticated()
```

## 密码加密

**文件位置**: `config/PasswordEncoderConfig.java`

```java
@Configuration
public class PasswordEncoderConfig {

    @Bean
    public PasswordEncoder passwordEncoder() {
        // 使用 BCrypt 算法
        return new BCryptPasswordEncoder();
    }
}
```

## UserDetailsImpl - Spring Security 用户详情

**文件位置**: `security/UserDetailsImpl.java`

```java
@Data
@AllArgsConstructor
public class UserDetailsImpl implements UserDetails {

    private Integer id;
    private String username;
    private String email;
    private String password;

    public static UserDetailsImpl build(User user) {
        return new UserDetailsImpl(
                user.getId(),
                user.getUsername(),
                user.getEmail(),
                user.getPassword()
        );
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return Collections.singletonList(new SimpleGrantedAuthority("ROLE_USER"));
    }

    @Override
    public boolean isAccountNonExpired() { return true; }

    @Override
    public boolean isAccountNonLocked() { return true; }

    @Override
    public boolean isCredentialsNonExpired() { return true; }

    @Override
    public boolean isEnabled() { return true; }
}
```

## 相关笔记

- [[09-JWT实现]]
- [[10-统一响应封装]]
- [[11-配置类]]

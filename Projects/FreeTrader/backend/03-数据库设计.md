# 数据库设计

## 数据库配置

```yaml
spring:
  datasource:
    url: jdbc:mysql://106.12.52.116:1999/freetrader?useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: free
    password: free123
    driver-class-name: com.mysql.cj.jdbc.Driver
```

## 数据库版本

- **MySQL**: 8.0.36

## 表结构概览

| 表名 | 说明 |
|------|------|
| user_info | 用户信息表 |
| category | ETF 板块分类表 |
| etf_info | ETF 基本信息表 |
| etf_netasset | ETF 净值数据表 |
| calendar | 交易日历表 |
| user_collection | 用户收藏表 |

## ER 关系图

```
user_info (1) ──────── (N) user_collection (N) ──────── (1) category
                         │
                         └── (N) etf_info (1) ──────── (N) etf_netasset
                                                        │
                                                        └── calendar
```

## 详细表结构

### user_info - 用户信息表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INT UNSIGNED | PK, AUTO_INCREMENT | 用户唯一标识 |
| username | VARCHAR(50) | NOT NULL, UNIQUE | 用户名 |
| email | VARCHAR(100) | NOT NULL, UNIQUE | 邮箱 |
| password | VARCHAR(255) | NOT NULL | 加密密码 |
| created_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE | 更新时间 |
| deleted_at | DATETIME | NULL | 软删除时间 |

### category - 板块分类表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| cid | INT | PK, AUTO_INCREMENT | 分类唯一标识 |
| name | VARCHAR(100) | NOT NULL, UNIQUE | 分类名称 |
| description | TEXT | NULL | 分类描述 |
| sort_order | INT | NOT NULL, DEFAULT 0 | 排序权重 |
| status | TINYINT | NOT NULL, DEFAULT 1 | 状态：1-启用，0-禁用 |
| item_count | INT | NOT NULL, DEFAULT 0 | 包含的 ETF 数量 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

### etf_info - ETF 基本信息表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| ths_code | VARCHAR(32) | PK | 同花顺代码 |
| chinese_name | VARCHAR(64) | NULL | 中文名称 |
| sector | VARCHAR(32) | NULL | 所属板块 |
| start_day | DATE | NULL | 起始日期 |
| end_day | DATE | NULL | 结束日期 |

**触发器**：
- `tr_etf_insert_after` - 插入后自动更新板块计数
- `tr_etf_update_after` - 更新后自动调整板块计数
- `tr_etf_delete_after` - 删除后自动减少板块计数

### etf_netasset - ETF 净值数据表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| ths_code | VARCHAR(32) | PK, FK | ETF 代码 |
| time | DATE | PK | 日期 |
| net_asset_value | FLOAT | NULL | 单位净值 |
| adjusted_nav | FLOAT | NULL | 复权单位净值 |
| accumulated_nav | FLOAT | NULL | 累计单位净值 |
| premium | FLOAT | NULL | 贴水 |
| premium_ratio | FLOAT | NULL | 贴水率 |

### calendar - 交易日历表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| Day | VARCHAR(8) | PK | 日期 (yyyyMMdd) |
| IsTradingDay | TINYINT | NULL | 是否交易日 |
| IsWorkingDay | TINYINT | NULL | 是否工作日 |
| Comments | VARCHAR(255) | NULL | 备注 |
| FetchHoliday | TINYINT | NULL | 节假日标记 |
| UpdateTime | VARCHAR(50) | NULL | 更新时间 |

### user_collection - 用户收藏表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| collect_id | INT UNSIGNED | PK, AUTO_INCREMENT | 收藏记录标识 |
| user_id | INT UNSIGNED | FK, NOT NULL | 用户ID |
| cid | INT | FK, NOT NULL | 板块ID |
| collect_time | DATETIME | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 收藏时间 |

**外键约束**：
- `fk_collection_user` - `user_id` → `user_info.id`，级联删除
- `fk_collection_category` - `cid` → `category.cid`，级联删除

**唯一索引**：
- `uk_user_cid` - `(user_id, cid)` 防止重复收藏

## 相关笔记

- [[02-项目架构]]
- [[04-实体层实现]]
